// Creo el storage account
resource "azurerm_storage_account" "brockuploads" {
  name                     = "${local.prefix}brockuploads"
  location                 = azurerm_resource_group.brock.location
  resource_group_name      = azurerm_resource_group.brock.name
  account_tier             = "Standard"
  account_replication_type = "LRS"
}

// Creo el contenedor
resource "azurerm_storage_container" "pokeballs" {
  name = "${local.prefix}pokeballs"
  storage_account_name = "${local.prefix}brockuploads"
  container_access_type = "private"
  depends_on = [ azurerm_storage_account.brockuploads]
}

// Creo el blob
resource "azurerm_storage_blob" "onix" {
  name = "onix.txt"
  storage_account_name = "${local.prefix}brockuploads"
  storage_container_name=  "${local.prefix}pokeballs"
  type = "Block"
  source = "onix.txt"

  depends_on = [azurerm_storage_container.pokeballs]
}

// Obtengo el Rol de Contributor
data "azurerm_role_definition" "contributor" {
  name = "Contributor"
}

// Asignar al system managed identity el rol de contribuidor a un storage account
resource "azurerm_role_assignment" "example" {
  scope              = azurerm_storage_account.brockuploads.id
  role_definition_id = "${data.azurerm_subscription.current.id}${data.azurerm_role_definition.contributor.id}"
  principal_id       = azurerm_linux_web_app.res-19.identity[0].principal_id

  depends_on = [azurerm_storage_container.pokeballs, azurerm_linux_web_app.res-19]
}