// azure frontdoor profile
resource "azurerm_cdn_profile" "res-1" {
  location            = "global"
  name                = "pokemoncen-${random_password.prefix_wordpress.result}-cdnprofile"
  resource_group_name = azurerm_resource_group.res-0.name
  sku                 = "Standard_Microsoft"
  tags = {
    AppProfile = "Wordpress"
  }

  depends_on = [
    azurerm_resource_group.res-0,
  ]
}

// azure frontdoor endpoint
resource "azurerm_cdn_endpoint" "res-2" {
  is_compression_enabled = true
  location               = "global"
  name                   = "pokemoncen-${random_password.prefix_wordpress.result}-endpoint"
  origin_host_header     = "${random_password.prefix_wordpress.result}pokemoncenter.azurewebsites.net"
  profile_name           = azurerm_cdn_profile.res-1.name
  resource_group_name    = azurerm_resource_group.res-0.name
  tags = {
    AppProfile = "Wordpress"
  }
  content_types_to_compress = [
              "application/eot",
              "application/font",
              "application/font-sfnt",
              "application/javascript",
              "application/json",
              "application/opentype",
              "application/otf",
              "application/pkcs7-mime",
              "application/truetype",
              "application/ttf",
              "application/vnd.ms-fontobject",
              "application/x-font-opentype",
              "application/x-font-truetype",
              "application/x-font-ttf",
              "application/x-httpd-cgi",
              "application/x-javascript",
              "application/x-mpegurl",
              "application/x-opentype",
              "application/x-otf",
              "application/x-perl",
              "application/x-ttf",
              "application/xhtml+xml",
              "application/xml",
              "application/xml+rss",
              "font/eot",
              "font/opentype",
              "font/otf",
              "font/ttf",
              "image/svg+xml",
              "text/css",
              "text/csv",
              "text/html",
              "text/javascript",
              "text/js",
              "text/plain",
              "text/richtext",
              "text/tab-separated-values",
              "text/x-component",
              "text/x-java-source",
              "text/x-script",
              "text/xml"
  ]
  delivery_rule {
    name  = "CORS"
    order = 1
    modify_response_header_action {
      action = "Overwrite"
      name   = "Access-Control-Allow-Origin"
      value  = "https://${random_password.prefix_wordpress.result}pokemoncenter.azurewebsites.net"
    }
    request_header_condition {
      match_values = ["https://${random_password.prefix_wordpress.result}pokemoncenter"]
      operator     = "BeginsWith"
      selector     = "Origin"
    }
    request_header_condition {
      match_values = [".azurewebsites.net"]
      operator     = "EndsWith"
      selector     = "Origin"
    }
  }
  origin {
    host_name = "${random_password.prefix_wordpress.result}pokemoncenter.azurewebsites.net"
    name      = "pokemoncenter-azurewebsites-net"
  }
  depends_on = [
    azurerm_cdn_profile.res-1,
    azurerm_resource_group.res-0,
  ]
}

// Creo una zona dns privada para asociarla al dbserver
resource "azurerm_private_dns_zone" "res-11" {
  name                = "pokemoncen-${random_password.prefix_wordpress.result}-privatelink.mysql.database.azure.com"
  resource_group_name = azurerm_resource_group.res-0.name
  tags = {
    AppProfile = "Wordpress"
  }
  depends_on = [
    azurerm_resource_group.res-0
  ]
}

// Creo un registro dns para el dbserver
resource "azurerm_private_dns_a_record" "res-12" {
  name                = "pokemoncen-${random_password.prefix_wordpress.result}-dbserver"
  records             = ["10.0.0.132"]
  resource_group_name = azurerm_resource_group.res-0.name
  ttl                 = 10
  zone_name           = azurerm_private_dns_zone.res-11.name
  depends_on = [
    azurerm_private_dns_zone.res-11,
  ]
}

// Creo la red principal vnet 
resource "azurerm_virtual_network" "res-15" {
  address_space       = ["10.0.0.0/23"]
  location            = azurerm_resource_group.res-0.location
  name                = "pokemoncen-${random_password.prefix_wordpress.result}-vnet"
  resource_group_name = azurerm_resource_group.res-0.name

  tags = {
    AppProfile = "Wordpress"
  }
   depends_on = [
    azurerm_private_dns_zone.res-11

  ]
}

// Creo la subnet del wordpress (appsubnet)
resource "azurerm_subnet" "res-16" {
  address_prefixes     = ["10.0.0.0/25"]
  name                 = "pokemoncen-${random_password.prefix_wordpress.result}-appsubnet"
  resource_group_name  = azurerm_resource_group.res-0.name
  virtual_network_name = azurerm_virtual_network.res-15.name
  delegation {
    name = "dlg-appService"
    service_delegation {
      actions = ["Microsoft.Network/virtualNetworks/subnets/action"]
      name    = "Microsoft.Web/serverFarms"
    }
  }
  depends_on = [
    azurerm_virtual_network.res-15
  ]
}

// Creo la subnet de la base de datos (dbsubnet)
resource "azurerm_subnet" "res-17" {
  address_prefixes     = ["10.0.0.128/25"]
  name                 = "pokemoncen-${random_password.prefix_wordpress.result}-dbsubnet"
  resource_group_name  = azurerm_resource_group.res-0.name
  virtual_network_name = azurerm_virtual_network.res-15.name
  delegation {
    name = "dlg-appService"
    service_delegation {
      actions = ["Microsoft.Network/virtualNetworks/subnets/join/action"]
      name    = "Microsoft.DBforMySQL/flexibleServers"
    }
  }
  depends_on = [
    azurerm_virtual_network.res-15
  ]
}

// Asocio el private dns_zone a la vnet principal
resource "azurerm_private_dns_zone_virtual_network_link" "res-14" {
  name                  = "pokemoncen-${random_password.prefix_wordpress.result}-privatelink.mysql.database.azure.com-vnetlink"
  private_dns_zone_name = azurerm_private_dns_zone.res-11.name
  resource_group_name   = azurerm_resource_group.res-0.name
  virtual_network_id    = azurerm_virtual_network.res-15.id
  depends_on = [
    azurerm_virtual_network.res-15
  ]
}

// creo la dbserver para el wordpress
resource "azurerm_mysql_flexible_server" "res-4" {
  delegated_subnet_id = azurerm_subnet.res-17.id
  location            = azurerm_resource_group.res-0.location
  name                = "pokemoncen-${random_password.prefix_wordpress.result}-dbserver"
  private_dns_zone_id = azurerm_private_dns_zone.res-11.id
  administrator_login= "nktiqbidru"
  administrator_password= random_password.sql_password.result
  sku_name = "B_Standard_B1s"
  backup_retention_days = 7
  create_mode = null
  resource_group_name = azurerm_resource_group.res-0.name
  tags = {
    AppProfile = "Wordpress"
  }
  zone = "2"
  depends_on = [
    azurerm_private_dns_zone.res-11,
    azurerm_subnet.res-17,
    azurerm_private_dns_zone_virtual_network_link.res-14
  ]
}

// Creo la base de datos del wordpress
resource "azurerm_mysql_flexible_database" "res-8" {
  charset             = "utf8mb3"
  collation           = "utf8mb3_general_ci"
  name                = "pokemoncen_${random_password.prefix_wordpress.result}_database"
  resource_group_name = "${random_password.prefix_wordpress.result}-wordpress-rg"
  server_name         = azurerm_mysql_flexible_server.res-4.name
  depends_on = [
    azurerm_mysql_flexible_server.res-4,
  ]
}


// Creo un plan service para levantar la app
resource "azurerm_service_plan" "res-18" {
  location            = azurerm_resource_group.res-0.location
  name                = "ASP-wordpressrg-${random_password.prefix_wordpress.result}"
  os_type             = "Linux"
  resource_group_name = azurerm_resource_group.res-0.name
  sku_name            = "B1"
  tags = {
    AppProfile = "Wordpress"
  }
   depends_on = [
    azurerm_resource_group.res-0,
  ]
}

// Creo la webapp con la imagen docker del Wordpress y la configuración de la base de datos. Añado el service_plan
resource "azurerm_linux_web_app" "res-19" {
  app_settings = {
    CDN_ENABLED                           = "true"
    CDN_ENDPOINT                          = "pokemoncen-${random_password.prefix_wordpress.result}-endpoint.azureedge.net"
    DATABASE_HOST                         = "pokemoncen-${random_password.prefix_wordpress.result}-dbserver.mysql.database.azure.com"
    DATABASE_NAME                         = "pokemoncen_${random_password.prefix_wordpress.result}_database"
    DATABASE_PASSWORD                     = random_password.sql_password.result
    DATABASE_USERNAME                     = "nktiqbidru"
    SETUP_PHPMYADMIN                      = "true"
    WEBSITES_CONTAINER_START_TIME_LIMIT   = "1800"
    WEBSITES_ENABLE_APP_SERVICE_STORAGE   = "true"
    WORDPRESS_ADMIN_EMAIL                 = data.azuread_user.current_user.user_principal_name
    WORDPRESS_ADMIN_PASSWORD              = local.wordpress_password
    WORDPRESS_ADMIN_USER                  = local.wordpress_user
    WORDPRESS_LOCALE_CODE                 = "es_ES"
    WORDPRESS_LOCAL_STORAGE_CACHE_ENABLED = "true"
    WORDPRESS_TITLE                       = "WordPress en Azure"
  }
  location            = azurerm_resource_group.res-0.location
  name                = "${random_password.prefix_wordpress.result}pokemoncenter"
  resource_group_name = azurerm_resource_group.res-0.name
  service_plan_id     = azurerm_service_plan.res-18.id
  tags = {
    AppProfile = "Wordpress"
  }
  virtual_network_subnet_id = azurerm_subnet.res-16.id
  identity {
    type = "SystemAssigned"
  }
  site_config {
    ftps_state = "FtpsOnly"
    always_on        = true

    default_documents =  [
      "Default.htm",
      "Default.html",
      "Default.asp",
      "index.htm",
      "index.html",
      "iisstart.htm",
      "default.aspx",
      "index.php",
      "hostingstart.html",
    ]
    application_stack {
      docker_image_name = "appsvc/wordpress-alpine-php:8.2"
      docker_registry_url = "https://mcr.microsoft.com"
    }
  }

  depends_on = [
    azurerm_subnet.res-16,
    azurerm_service_plan.res-18,
    azurerm_private_dns_a_record.res-12,
    azurerm_mysql_flexible_server.res-4
  ]
}
